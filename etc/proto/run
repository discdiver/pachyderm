#!/bin/bash

tar xf /dev/stdin

# Make sure the proto compiler is reasonably up-to-date so that our compiled
# protobufs aren't generated by stale tools
max_age="$(date --date="1 month ago" +%s)"
if [[ "${max_age}" -gt "$(cat /last_run_time)" ]]; then
  PRE="\e[1;31m~\e[0m"
  echo -e "\e[1;31m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\e[0m" >/dev/stderr
  echo -e "${PRE} \e[1;31mWARNING:\e[0m pachyderm_proto is out of date" >/dev/stderr
  echo -e "${PRE} please run" >/dev/stderr
  echo -e "${PRE}   docker ps -aq --filter=ancestor=pachyderm_proto | xargs docker rm  "\#" rm all docker containers" >/dev/stderr
  echo -e "${PRE}   docker images -aq pachyderm_proto | xargs docker rmi" >/dev/stderr
  echo -e "${PRE}   docker image prune" >/dev/stderr
  echo -e "${PRE} and then re-run 'make proto'" >/dev/stderr
  echo -e "\e[1;31m~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\e[0m" >/dev/stderr
  exit 1
fi

for i in $(find src -name "*.proto"); do \
	protoc \
		-I${GOPATH}/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis \
		-I${GOPATH}/src/github.com/gogo/protobuf \
		-I${GOPATH}/src \
		-Isrc \
		--gofast_out=plugins=grpc,\
Mgoogle/protobuf/duration.proto=github.com/gogo/protobuf/types,\
Mgoogle/protobuf/empty.proto=github.com/gogo/protobuf/types,\
Mgoogle/protobuf/timestamp.proto=github.com/gogo/protobuf/types,\
Mgoogle/protobuf/wrappers.proto=github.com/gogo/protobuf/types,\
Mgogoproto/gogo.proto=github.com/gogo/protobuf/gogoproto,\
Mclient/pfs/pfs.proto=github.com/pachyderm/pachyderm/src/client/pfs,\
Mclient/pps/pps.proto=github.com/pachyderm/pachyderm/src/client/pps,\
Mclient/version/versionpb/version.proto=github.com/pachyderm/pachyderm/src/client/version/versionpb,\
Mclient/auth/auth.proto=github.com/pachyderm/pachyderm/src/client/auth,\
Mclient/admin/admin.proto=github.com/pachyderm/pachyderm/src/client/admin,\
Mserver/pfs/fuse/fuse.proto=github.com/pachyderm/pachyderm/src/server/pfs/fuse,\
:src \
	${i} 1>&2
done

find src -regex ".*\.go" | xargs tar cf -
